<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
      公司内网部署 | 华通云前端文档
    </title>
    <meta name="description" content="前端基础指南">
    <link rel="stylesheet" href="/wt-docs/assets/style.56d02f33.css">
    <link rel="modulepreload" href="/wt-docs/assets/Home.7f069dd5.js">
    <link rel="modulepreload" href="/wt-docs/assets/app.c212677f.js">
    <link rel="modulepreload" href="/wt-docs/assets/bale_index.md.5c5b5c52.lean.js">
    <link rel="modulepreload" href="/wt-docs/assets/app.c212677f.js">
    <link rel="icon" href="/images/favicon.ico">
    
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-6e7c0b86><div class="sidebar-button" data-v-6e7c0b86><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/wt-docs/" aria-label="华通云前端文档, back to home" data-v-6e7c0b86 data-v-76c79d52><!----> 华通云前端文档</a><div class="flex-grow" data-v-6e7c0b86></div><div class="nav" data-v-6e7c0b86><nav class="nav-links" data-v-6e7c0b86 data-v-f465d38e><!--[--><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/" data-v-99f6c566>首页 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/wt-cli" data-v-99f6c566>WATONE 命令行 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-dropdown-link" data-v-f465d38e data-v-517467a8><button class="button" data-v-517467a8><span class="button-text" data-v-517467a8>目录</span><span class="right button-arrow" data-v-517467a8></span></button><ul class="dialog" data-v-517467a8><!--[--><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/start/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>主页</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/css/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Css 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/js/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Js 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/vue/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Vue 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/element/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>组件规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/dataV/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>大屏规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/git/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Git规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/bale/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>打包规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/front-end/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>前端环境</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/front-end/" data-v-99f6c566>前端开发 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-dropdown-link" data-v-f465d38e data-v-517467a8><button class="button" data-v-517467a8><span class="button-text" data-v-517467a8>其他</span><span class="right button-arrow" data-v-517467a8></span></button><ul class="dialog" data-v-517467a8><!--[--><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/link/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>链接</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/resource/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>资源</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item isExternal" href="https://github.com/xkloveme/wt-docs" target="_blank" rel="noopener noreferrer" data-v-99f6c566>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-99f6c566><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-58e261f2><nav class="nav-links nav" data-v-58e261f2 data-v-f465d38e><!--[--><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/" data-v-99f6c566>首页 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/wt-cli" data-v-99f6c566>WATONE 命令行 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-dropdown-link" data-v-f465d38e data-v-517467a8><button class="button" data-v-517467a8><span class="button-text" data-v-517467a8>目录</span><span class="right button-arrow" data-v-517467a8></span></button><ul class="dialog" data-v-517467a8><!--[--><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/start/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>主页</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/css/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Css 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/js/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Js 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/vue/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Vue 规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/element/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>组件规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/dataV/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>大屏规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/git/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>Git规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/bale/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>打包规范</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/front-end/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>前端环境</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item" href="/wt-docs/front-end/" data-v-99f6c566>前端开发 <!----></a></div></div><div class="item" data-v-f465d38e><div class="nav-dropdown-link" data-v-f465d38e data-v-517467a8><button class="button" data-v-517467a8><span class="button-text" data-v-517467a8>其他</span><span class="right button-arrow" data-v-517467a8></span></button><ul class="dialog" data-v-517467a8><!--[--><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/link/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>链接</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><li class="dialog-item" data-v-517467a8><div class="nav-dropdown-link-item" data-v-517467a8 data-v-d552fd76><a class="item" href="/wt-docs/resource/" data-v-d552fd76><span class="arrow" data-v-d552fd76></span><span class="text" data-v-d552fd76>资源</span><span class="icon" data-v-d552fd76><!----></span></a></div></li><!--]--></ul></div></div><!--]--><!----><div class="item" data-v-f465d38e><div class="nav-link" data-v-f465d38e data-v-99f6c566><a class="item isExternal" href="https://github.com/xkloveme/wt-docs" target="_blank" rel="noopener noreferrer" data-v-99f6c566>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-99f6c566><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-58e261f2><!--[--><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#前言" data-v-58e261f2>前言</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#前端的-vue-打包与部署" data-v-58e261f2>前端的 Vue 打包与部署</a><ul class="sidebar-links" data-v-58e261f2><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#构建-vue-应用镜像" data-v-58e261f2>构建 vue 应用镜像</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#创建-nginx-config-配置文件" data-v-58e261f2>创建 nginx config 配置文件</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#创建-dockerfile-文件" data-v-58e261f2>创建 Dockerfile 文件</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#检测-docker-是否能够正常运行项目" data-v-58e261f2>检测 Docker 是否能够正常运行项目</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#重要-配置可执行的yaml文件" data-v-58e261f2>[重要]配置可执行的yaml文件</a><!----></li><li class="sidebar-link" data-v-58e261f2 data-v-58e261f2><a class="sidebar-link-item" href="#jenkins新的job" data-v-58e261f2>jenkins新的Job</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><!-- TODO: make this button accessible --><div class="sidebar-mask"></div><main class="page" data-v-d36a7fda><div class="container" data-v-d36a7fda><!--[--><!--]--><div class="content" data-v-d36a7fda><div data-v-d36a7fda><h1 id="公司内网部署"><a class="header-anchor" href="#公司内网部署" aria-hidden="true">#</a> 公司内网部署</h1><h2 id="前言"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><blockquote><p>我们依靠<code>docker</code>内网部署,通过<code>jenkins</code>构建工作流</p></blockquote><h2 id="前端的-vue-打包与部署"><a class="header-anchor" href="#前端的-vue-打包与部署" aria-hidden="true">#</a> 前端的 Vue 打包与部署</h2><p>小贴士：<span style="color:red;">前端打包统一采用相对路径,具体在文件<code>vue.config.js</code>进行如下配置:</span></p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 打包为相对路径</span>
  publicPath<span class="token operator">:</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 将构建好的文件输出到哪里</span>
  outputDir<span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 放置生成的静态资源(js、css、img、fonts)的目录。</span>
  assetsDir<span class="token operator">:</span> <span class="token string">&quot;static&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 指定生成的 index.html 的输出路径</span>
  indexPath<span class="token operator">:</span> <span class="token string">&quot;index.html&quot;</span><span class="token punctuation">,</span>

  <span class="token comment">// 是否使用包含运行时编译器的 Vue 构建版本。设置为 true 后你就可以在 Vue 组件中使用 template 选项了，但是这会让你的应用额外增加 10kb 左右。</span>
  runtimeCompiler<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

  <span class="token comment">// 默认情况下 babel-loader 会忽略所有 node_modules 中的文件。如果你想要通过 Babel 显式转译一个依赖，可以在这个选项中列出来。</span>
  transpileDependencies<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// 生产环境关闭 source map</span>
  productionSourceMap<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="构建-vue-应用镜像"><a class="header-anchor" href="#构建-vue-应用镜像" aria-hidden="true">#</a> 构建 vue 应用镜像</h3><blockquote><p>nginx 是一个高性能的 HTTP 和反向代理服务器，此处我们选用 nginx 镜像作为基础来构建我们的 vue 应用镜像。</p></blockquote><h3 id="创建-nginx-config-配置文件"><a class="header-anchor" href="#创建-nginx-config-配置文件" aria-hidden="true">#</a> 创建 nginx config 配置文件</h3><p><img src="https://files.catbox.moe/lya17n.png" alt=""></p><ul><li>1.我们在根目录下创建<code>conf</code>文件夹</li><li>2.新建<code>default.conf</code>和<code>nginx.conf</code></li></ul><blockquote><p><code>default.conf</code>文件:</p></blockquote><div class="tip custom-block"><p class="custom-block-title">说明</p><div class="language-bash"><pre><code>location /api/ <span class="token punctuation">{</span>
    		proxy_pass http://watone-gateway:3204/<span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
</code></pre></div><p><span style="color:red;">需要根据配置的后端地址改变而改变,访问不到的话会导致报错</span></p></div><div class="language-bash"><pre><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">3000</span><span class="token punctuation">;</span>
    server_name  localhost<span class="token punctuation">;</span>
    <span class="token comment">#charset koi8-r;</span>
    <span class="token comment">#access_log  /var/log/nginx/host.access.log  main;</span>
    <span class="token comment">#error_log  /var/log/nginx/host.error.log;</span>
    location / <span class="token punctuation">{</span>
        add_header X-Frame-Options SAMEORIGIN<span class="token punctuation">;</span>
        add_header Access-Control-Allow-Origin *<span class="token punctuation">;</span>
        add_header Access-Control-Allow-Methods GET,POST,OPTIONS<span class="token punctuation">;</span>
        add_header Access-Control-Allow-Credentials <span class="token boolean">true</span><span class="token punctuation">;</span>
        add_header Access-Control-Allow-Headers X-Requested-With<span class="token punctuation">;</span>
         <span class="token comment"># disable cache html</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>
        index  index.html index.htm index.shtml<span class="token punctuation">;</span>
        try_files <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    location /api/ <span class="token punctuation">{</span>
    		proxy_pass http://watone-gateway:3204/<span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    <span class="token comment">#error_page  404              /404.html;</span>

    <span class="token comment"># redirect server error pages to the static page /50x.html</span>
    <span class="token comment">#</span>
    error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html<span class="token punctuation">;</span>
    location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
        root   /usr/share/nginx/html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># deny access to .htaccess files, if Apache&#39;s document root</span>
    <span class="token comment"># concurs with nginx&#39;s one</span>
    <span class="token comment">#</span>
    <span class="token comment">#location ~ /\.ht {</span>
    <span class="token comment">#    deny  all;</span>
    <span class="token comment">#}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><code>nginx.conf</code>文件:</p></blockquote><div class="language-bash"><pre><code>user  nginx<span class="token punctuation">;</span>
worker_processes  auto<span class="token punctuation">;</span>

error_log  /var/log/nginx/error.log warn<span class="token punctuation">;</span>
pid        /var/run/nginx.pid<span class="token punctuation">;</span>

events <span class="token punctuation">{</span>
    use epoll<span class="token punctuation">;</span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{</span>
    include       /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type  application/octet-stream<span class="token punctuation">;</span>

    log_format  main  <span class="token string">&#39;<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] &quot;<span class="token variable">$request</span>&quot; &#39;</span>
                      <span class="token string">&#39;<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> &quot;<span class="token variable">$http_referer</span>&quot; &#39;</span>
                      <span class="token string">&#39;&quot;<span class="token variable">$http_user_agent</span>&quot; &quot;<span class="token variable">$http_x_forwarded_for</span>&quot;&#39;</span><span class="token punctuation">;</span>
    <span class="token comment">#access_log  /var/log/nginx/access.log  main;</span>

    sendfile       on<span class="token punctuation">;</span>
    tcp_nopush     on<span class="token punctuation">;</span>
    tcp_nodelay    on<span class="token punctuation">;</span>
    client_header_timeout <span class="token number">15</span><span class="token punctuation">;</span>
    client_body_timeout <span class="token number">15</span><span class="token punctuation">;</span>
    send_timeout <span class="token number">15</span><span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>

    client_max_body_size 300m<span class="token punctuation">;</span>

    <span class="token function">gzip</span>  on<span class="token punctuation">;</span>
    gzip_min_length 1k<span class="token punctuation">;</span>
    gzip_buffers <span class="token number">4</span> 16k<span class="token punctuation">;</span>
    gzip_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
    gzip_comp_level <span class="token number">6</span><span class="token punctuation">;</span>
    gzip_types text/plain application/javascript application/x-javascript
text/javascript text/css application/xml<span class="token punctuation">;</span>
    gzip_vary on<span class="token punctuation">;</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建-dockerfile-文件"><a class="header-anchor" href="#创建-dockerfile-文件" aria-hidden="true">#</a> 创建 Dockerfile 文件</h3><blockquote><p>在项目外层新建<code>dockerfile</code>文件:</p></blockquote><div class="language-bash"><pre><code><span class="token comment"># Citybrain nginx Dockerfile</span>
<span class="token comment"># Version 1.0</span>
<span class="token comment"># Base images 基础镜像</span>
FROM nginx:1.16.0-alpine
<span class="token comment">#LABEL 维护者信息</span>
LABEL caosx caosx@watone.com.cn
<span class="token comment">#COPY</span>
COPY ./dist/ /usr/share/nginx/html/
COPY ./conf/nginx.conf /etc/nginx/nginx.conf
COPY ./conf/default.conf /etc/nginx/conf.d/default.conf
<span class="token comment">#RUN 赋予权限</span>
RUN <span class="token function">chown</span> -R nginx. /usr/share/nginx
<span class="token comment">#EXPOSE 映射端口</span>
EXPOSE <span class="token number">8000</span>
<span class="token comment">#ENTRYPOINT 运行以下命令</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">&quot;nginx&quot;</span>, <span class="token string">&quot;-g&quot;</span>, <span class="token string">&quot;daemon off;&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="检测-docker-是否能够正常运行项目"><a class="header-anchor" href="#检测-docker-是否能够正常运行项目" aria-hidden="true">#</a> 检测 Docker 是否能够正常运行项目</h3><ul><li>在根目录新建<code>run.sh</code>文件:</li></ul><div class="language-bash"><pre><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 这里以watone-jw-h5项目为例</span>
<span class="token assign-left variable">ENVIRONMENT</span><span class="token operator">=</span><span class="token string">&#39;watone-jw-h5&#39;</span>

docker build <span class="token builtin class-name">.</span> -t <span class="token variable">${ENVIRONMENT}</span>
docker run --rm -it  -p <span class="token number">9527</span>:80/tcp <span class="token variable">${ENVIRONMENT}</span>:latest
</code></pre></div><ul><li>运行脚本</li></ul><div class="language-bash"><pre><code><span class="token function">sh</span> run.sh
</code></pre></div><ul><li>打开链接 <blockquote><p><a href="http://localhost:9527/#/" target="_blank" rel="noopener noreferrer">http://localhost:9527/#/</a></p></blockquote></li></ul><p><span style="color:green;">能够顺利打开证明 Docker 能够正常运行项目</span></p><h3 id="重要-配置可执行的yaml文件"><a class="header-anchor" href="#重要-配置可执行的yaml文件" aria-hidden="true">#</a> [重要]配置可执行的<code>yaml</code>文件</h3><div class="danger custom-block"><p class="custom-block-title">重要</p><p>配置运行脚本,关系重大,务必检查仔细,包括端口,项目名称,避免冲突其他服务和端口</p></div><blockquote><p>以下均以<code>watone-jw-web</code>项目为例</p></blockquote><ul><li>在根目录新建<code>watone-jw-web-deployment.yaml</code>文件:</li></ul><div class="language-bash"><pre><code>---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: watone-jw-web
  namespace: lajw
  labels:
    web: watone-jw-web
spec:
  replicas: <span class="token number">3</span>
  selector:
    matchLabels:
      web: watone-jw-web
  template:
    metadata:
      labels:
        web: watone-jw-web
    spec:
      nodeSelector:
        role2: worker
      imagePullSecrets:
        - name: image
      containers:
        - name: watone-jw-web
          image: reg.watone.local/lajw/watone-jw-web:latest
          imagePullPolicy: <span class="token string">&quot;Always&quot;</span>
          ports:
            - containerPort: <span class="token number">3000</span>

---
apiVersion: v1
kind: Service
metadata:
  name: watone-jw-web
  namespace: lajw
  labels:
    web: watone-jw-web
spec:
  type: NodePort
  ports:
    - name: watone-jw-web
      port: <span class="token number">3000</span>
      targetPort: <span class="token number">3000</span>
      nodePort: <span class="token number">33000</span>
  selector:
    web: watone-jw-web
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">注意 ⚠️ 事项</p><p style="color:red;">1.需要改动文件名称加`XXX-deployment.yaml`</p><p style="color:red;">2.以上`watone-jw-web`内容需要修改为自己项目名称`XXX`</p><p style="color:red;">3.如果不需要太多部署备份服务`replicas: 3`可以改为`replicas: 1`</p><p style="color:red;">4.`33000`端口是基础端口,看需要增加新的端口,➕1或➕2者往后加,后端服务一般在200之后,不太清楚的话,咨询其他人</p></div><h3 id="jenkins新的job"><a class="header-anchor" href="#jenkins新的job" aria-hidden="true">#</a> <code>jenkins</code>新的<code>Job</code></h3><ul><li>新建<code>jenkinsfile</code>文件,把 URL 改为本项目 URL</li></ul><div class="language-js"><pre><code>pipeline <span class="token punctuation">{</span>
	agent any
  <span class="token comment">// agent {</span>
  <span class="token comment">// 	docker {</span>
  <span class="token comment">// 		image &#39;reg.watone.local/library/yarn:v1.22.4&#39;</span>
  <span class="token comment">// 		args &#39;-v /usr/bin/docker:/usr/bin/docker -v /var/run/docker.sock:/var/run/docker.sock&#39;</span>
  <span class="token comment">// 	}</span>
  <span class="token comment">// }</span>

  stages <span class="token punctuation">{</span>
    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Git Checkout&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
            <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">[</span>$<span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&#39;GitSCM&#39;</span><span class="token punctuation">,</span> branches<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>name<span class="token operator">:</span> <span class="token string">&quot;$BRANCHES&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doGenerateSubmoduleConfigurations<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> submoduleCfg<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> userRemoteConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>credentialsId<span class="token operator">:</span> <span class="token string">&#39;df5d99a0-9b4f-4ac1-aaaa-6e0865e0cd67&#39;</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">&#39;git@47.111.5.200:la-jw/watone-jw-web.git&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Yarn Build&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// agent { docker &#39;reg.watone.local/library/yarn:v1.22.4&#39; }</span>
        steps <span class="token punctuation">{</span>
            sh <span class="token string">&#39;&#39;</span>&#39;
            yarn install
            yarn build
            <span class="token string">&#39;&#39;</span>&#39;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;docker push&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
          script <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">PROFILES</span> <span class="token operator">==</span> <span class="token string">&#39;pre&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              sh <span class="token string">&#39;&#39;</span>&#39;
              echo <span class="token string">&quot;构建并推送镜像到: ${REGISTRY} 仓库！！！&quot;</span>
              docker login <span class="token operator">-</span>u $<span class="token punctuation">{</span><span class="token constant">ACCOUNT</span><span class="token punctuation">}</span> <span class="token operator">-</span>p $<span class="token punctuation">{</span><span class="token constant">PASSWD</span><span class="token punctuation">}</span> $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span>
              docker build <span class="token operator">-</span>t $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">-</span>pre<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span> <span class="token operator">-</span>f dockerfile <span class="token punctuation">.</span>
              docker push $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">-</span>pre<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span>
              sleep <span class="token number">3</span>
              docker rmi $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">-</span>pre<span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span>
              <span class="token string">&#39;&#39;</span>&#39;
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">PROFILES</span> <span class="token operator">==</span> <span class="token string">&#39;prod&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              sh <span class="token string">&#39;&#39;</span>&#39;
              echo <span class="token string">&quot;构建并推送镜像到: ${REGISTRY} 仓库！！！&quot;</span>
              docker login <span class="token operator">-</span>u $<span class="token punctuation">{</span><span class="token constant">ACCOUNT</span><span class="token punctuation">}</span> <span class="token operator">-</span>p $<span class="token punctuation">{</span><span class="token constant">PASSWD</span><span class="token punctuation">}</span> $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span>
              docker build <span class="token operator">-</span>t $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span> <span class="token operator">-</span>f dockerfile <span class="token punctuation">.</span>
              docker push $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span>
              sleep <span class="token number">3</span>
              docker rmi $<span class="token punctuation">{</span><span class="token constant">REGISTRY</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">PROJECT_NAME</span><span class="token punctuation">}</span><span class="token operator">/</span>$<span class="token punctuation">{</span><span class="token constant">IMAGE_NAME</span><span class="token punctuation">}</span><span class="token operator">:</span>$<span class="token punctuation">{</span><span class="token constant">VERSION</span><span class="token punctuation">}</span>
              <span class="token string">&#39;&#39;</span>&#39;
            <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span><span class="token punctuation">(</span><span class="token string">&#39;Deploy to k8s&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
            script <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token constant">PROFILES</span> <span class="token operator">==</span> <span class="token string">&#39;prod&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    echo <span class="token string">&#39;接下来进行生产项目的发布...&#39;</span>
                    sh <span class="token string">&#39;&#39;</span>&#39;
                    sed <span class="token operator">-</span>i <span class="token string">&quot;/image/{s/latest/${VERSION}/}&quot;</span>  $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span>
                    sshpass scp $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span> root@<span class="token number">172.18</span><span class="token number">.39</span><span class="token number">.191</span><span class="token operator">:</span><span class="token operator">/</span>root<span class="token operator">/</span>caosx<span class="token operator">/</span>yml
                    sshpass ssh root@<span class="token number">172.18</span><span class="token number">.39</span><span class="token number">.191</span> <span class="token string">&quot;kubectl apply -f /root/caosx/yml/${DEPLOYMENT}&quot;</span>
                    <span class="token string">&#39;&#39;</span>&#39;
                    <span class="token comment">// kubernetesDeploy configs: &#39;watone-jw-web-deployment.yaml&#39;, kubeConfig: [path: &#39;&#39;], kubeconfigId: &#39;3ab9d4b4-ffb9-44af-ab49-c17b64161198&#39;, secretName: &#39;&#39;, ssh: [sshCredentialsId: &#39;*&#39;, sshServer: &#39;&#39;], textCredentials: [certificateAuthorityData: &#39;&#39;, clientCertificateData: &#39;&#39;, clientKeyData: &#39;&#39;, serverUrl: &#39;https://&#39;]</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// if ( PROFILES == &#39;test&#39; ) {</span>
                <span class="token comment">//     echo &#39;接下来进行测试项目的发布...&#39;</span>
                <span class="token comment">//     sh &#39;&#39;&#39;</span>
                <span class="token comment">//     sed -i &quot;/image/{s/latest/${VERSION}/}&quot;  deploy.yaml</span>
                <span class="token comment">//     &#39;&#39;&#39;</span>
                <span class="token comment">//     kubernetesDeploy configs: &#39;deploy.yaml&#39;, kubeConfig: [path: &#39;&#39;], kubeconfigId: &#39;3ab9d4b4-ffb9-44af-ab49-c17b64161198&#39;, secretName: &#39;&#39;, ssh: [sshCredentialsId: &#39;*&#39;, sshServer: &#39;&#39;], textCredentials: [certificateAuthorityData: &#39;&#39;, clientCertificateData: &#39;&#39;, clientKeyData: &#39;&#39;, serverUrl: &#39;https://&#39;]</span>
                <span class="token comment">// }</span>

                <span class="token comment">// if ( PROFILES == &#39;pre&#39; ) {</span>
                <span class="token comment">//     echo &#39;接下来进行预发项目的发布...&#39;</span>
                <span class="token comment">//     sh &#39;&#39;&#39;</span>
                <span class="token comment">//     sed -i &quot;/image/{s/latest/${VERSION}/}&quot;  deploy.yaml</span>
                <span class="token comment">//     &#39;&#39;&#39;</span>
                <span class="token comment">//     kubernetesDeploy configs: &#39;deploy.yaml&#39;, kubeConfig: [path: &#39;&#39;], kubeconfigId: &#39;3ab9d4b4-ffb9-44af-ab49-c17b64161198&#39;, secretName: &#39;&#39;, ssh: [sshCredentialsId: &#39;*&#39;, sshServer: &#39;&#39;], textCredentials: [certificateAuthorityData: &#39;&#39;, clientCertificateData: &#39;&#39;, clientKeyData: &#39;&#39;, serverUrl: &#39;https://&#39;]</span>
                <span class="token comment">// }</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token constant">PROFILES</span> <span class="token operator">==</span> <span class="token string">&#39;pre&#39;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   echo <span class="token string">&#39;接下来进行预发项目的发布...&#39;</span>
                   sh <span class="token string">&#39;&#39;</span>&#39;
                   sed <span class="token operator">-</span>i <span class="token string">&quot;/image/{s/latest/${VERSION}/}&quot;</span>  $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span>
                   sed <span class="token operator">-</span>i <span class="token string">&quot;/image/{s/${PROJECT_NAME}/${PROJECT_NAME}-pre/}&quot;</span>  $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span>
                   sed <span class="token operator">-</span>i <span class="token string">&quot;/profiles/{s/profiles/${PROFILES}/}&quot;</span>  $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span>
                   sshpass scp $<span class="token punctuation">{</span><span class="token constant">DEPLOYMENT</span><span class="token punctuation">}</span> root@<span class="token number">172.18</span><span class="token number">.19</span><span class="token number">.216</span><span class="token operator">:</span><span class="token operator">/</span>root<span class="token operator">/</span>caosx<span class="token operator">/</span>yml
                   sshpass ssh root@<span class="token number">172.18</span><span class="token number">.19</span><span class="token number">.216</span> <span class="token string">&quot;kubectl apply -f /root/caosx/yml/${DEPLOYMENT}&quot;</span>
                   <span class="token string">&#39;&#39;</span>&#39;
              <span class="token comment">//     kubernetesDeploy configs: &#39;deploy.yaml&#39;, kubeConfig: [path: &#39;&#39;], kubeconfigId: &#39;3ab9d4b4-ffb9-44af-ab49-c17b64161198&#39;, secretName: &#39;&#39;, ssh: [sshCredentialsId: &#39;*&#39;, sshServer: &#39;&#39;], textCredentials: [certificateAuthorityData: &#39;&#39;, clientCertificateData: &#39;&#39;, clientKeyData: &#39;&#39;, serverUrl: &#39;https://&#39;]</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">stage</span> <span class="token punctuation">(</span><span class="token string">&#39;Post-Build&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        steps <span class="token punctuation">{</span>
            script <span class="token punctuation">{</span>
                currentBuild<span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">&quot;${VERSION}&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><img src="https://files.catbox.moe/tyvrs3.png" alt=""></p><blockquote><p>命名一般采用:测试化境-项目名称+test,正式环境-项目名称</p></blockquote><ul><li>复制一个<code>job</code>从<code>watone-jw-web</code>,指定一个分支</li></ul><p><img src="https://files.catbox.moe/rxb4z4.png" alt=""></p><ul><li>点击保存,大功告成</li></ul></div></div><footer class="page-footer" data-v-d36a7fda data-v-5a019cc9><div class="edit" data-v-5a019cc9><div class="edit-link" data-v-5a019cc9 data-v-fb0131f2><!----></div></div><div class="updated" data-v-5a019cc9><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"e896b72b\",\"wt-cli.md\":\"a4fa86d3\",\"bale_index.md\":\"5c5b5c52\",\"css_index.md\":\"b16856a0\",\"datav_index.md\":\"ab5e83bf\",\"element_index.md\":\"28bb56e1\",\"front-end_chrome.md\":\"172567e8\",\"front-end_command.md\":\"1cf00947\",\"front-end_fe.md\":\"59dee1b9\",\"front-end_git.md\":\"ab21ad1e\",\"front-end_github.md\":\"6c8fe1a9\",\"front-end_index.md\":\"6b9c8b7b\",\"front-end_la-ft.md\":\"9e8ef355\",\"front-end_mac.md\":\"96189b18\",\"front-end_node.md\":\"c822b714\",\"front-end_shell.md\":\"5cbb5fb4\",\"front-end_ts.md\":\"a2b88edb\",\"front-end_utils.md\":\"ff6197f8\",\"front-end_vim.md\":\"2d903959\",\"front-end_vscode.md\":\"54a722ba\",\"front-end_zlb.md\":\"aefd8847\",\"git_index.md\":\"ca431e53\",\"js_index.md\":\"298fb9f1\",\"link_index.md\":\"d7db7472\",\"resource_index.md\":\"8bbd63a2\",\"start_readme.md\":\"4f57e675\",\"start_index.md\":\"22f36c1d\",\"vue_index.md\":\"4dfddff0\"}")</script>
    <script type="module" async src="/wt-docs/assets/app.c212677f.js"></script>
  </body>
</html>